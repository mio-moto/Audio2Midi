name: Publish & Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - rid: win-x64
            artifact: Audio2Midi-win-x64
            exe: Audio2Midi.exe
          - rid: osx-arm64
            artifact: Audio2Midi-osx-arm64
            exe: Audio2Midi

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
      - name: Restore
        run: dotnet restore
      - name: Publish
        run: >
          dotnet publish Audio2Midi.CLI/Audio2Midi.CLI.csproj
          -c Release
          -f net10.0
          -r ${{ matrix.rid }}
          --self-contained true
          -o publish/${{ matrix.rid }}
          /p:PublishReadyToRun=true
          /p:PublishTrimmed=true
      - name: Fix permissions (macOS)
        if: matrix.rid == 'osx-arm64'
        run: chmod +x publish/${{ matrix.rid }}/${{ matrix.exe }}
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: publish/${{ matrix.rid }}/${{ matrix.exe }}

  release:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}